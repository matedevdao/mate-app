{"version":3,"file":"chat.js","sourceRoot":"","sources":["../../src/components/chat.ts"],"names":[],"mappings":"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","sourcesContent":["import { el } from '@webtaku/el';\nimport { getAddress } from 'viem';\nimport { Profile } from '../api/profile';\nimport { TokenManager } from '../auth/token-mananger';\nimport { ChatMessage, ChatService } from '../services/chat';\nimport { profileService } from '../services/profile';\nimport { Attachment } from '../types/chat';\nimport { shortenAddress } from '../utils/address';\nimport './chat.css';\nimport { Component } from './component';\nimport { createJazzicon } from './jazzicon';\n\ndeclare const API_URI: string;\n\ninterface Options {\n  roomId: string;\n  myAccount: string;\n}\n\nasync function waitForImages(node: HTMLElement) {\n  const imgs = Array.from(node.querySelectorAll('img'));\n  await Promise.all(\n    imgs.map(img => {\n      if (img.complete) return Promise.resolve();\n      return new Promise<void>(resolve => {\n        img.addEventListener('load', () => resolve(), { once: true });\n        img.addEventListener('error', () => resolve(), { once: true });\n      });\n    })\n  );\n}\n\nfunction replaceWithFallback(img: HTMLImageElement) {\n  const wrapper = el('div.img-fallback');\n  wrapper.style.width = '180px';\n  wrapper.style.height = '120px';\n  wrapper.style.display = 'flex';\n  wrapper.style.flexDirection = 'column';\n  wrapper.style.justifyContent = 'center';\n  wrapper.style.alignItems = 'center';\n  wrapper.style.border = '1px solid var(--sl-color-neutral-200)';\n  wrapper.style.borderRadius = '8px';\n  wrapper.style.boxSizing = 'border-box';\n\n  const icon = el('sl-icon', { name: 'image' });\n  icon.style.fontSize = '48px';\n  icon.style.color = 'var(--sl-color-neutral-500)';\n\n  const msg = el('div', '불러올 수 없음');\n  msg.style.fontSize = '12px';\n  msg.style.color = 'var(--sl-color-neutral-600)';\n\n  wrapper.append(icon, msg);\n  img.replaceWith(wrapper);\n}\n\nfunction createChatComponent({ roomId, myAccount }: Options): Component & {\n  scrollToBottom: () => void;\n} {\n  const pendingAttachments: { file: File, blobUrl: string }[] = [];\n\n  const root = el('div.chat-component');\n  const list = el('div.message-list');\n  const input = el('sl-input', { placeholder: 'Type a message…', pill: true });\n  const sendBtn = el('sl-button', { variant: 'primary', pill: true }, 'Send');\n  const attachBtn = el('sl-button', { variant: 'default', circle: true },\n    el('sl-icon', { name: 'paperclip' })\n  );\n  const fileInput = el('input', { type: 'file', accept: 'image/*', multiple: true, style: 'display:none' });\n\n  const composer = el('div.composer', input, fileInput, attachBtn, sendBtn);\n\n  const thumbBar = el('div.thumb-bar');\n\n  root.append(list, thumbBar, composer);\n\n  const service = new ChatService(roomId);\n  service.connect();\n\n  profileService.addEventListener('profilechange', (e) => {\n    const { account, profile } = (e as CustomEvent<{\n      account: `0x${string}`, profile: Profile,\n    }>).detail;\n    list.querySelectorAll<HTMLElement>(`.message .name[data-account=\"${account}\"]`)\n      .forEach(node => {\n        node.textContent = profile.nickname ?? shortenAddress(account);\n      });\n  });\n\n  function pushThumb(file: File, blobUrl: string) {\n    const wrapper = el('div.thumb-wrapper');\n    const img = el('img.thumb', { src: blobUrl });\n    const removeBtn = el('button.remove', '×');\n\n    removeBtn.onclick = () => {\n      const idx = pendingAttachments.findIndex(p => p.blobUrl === blobUrl);\n      if (idx >= 0) {\n        URL.revokeObjectURL(pendingAttachments[idx].blobUrl);\n        pendingAttachments.splice(idx, 1);\n      }\n      wrapper.remove();\n    };\n\n    wrapper.append(img, removeBtn);\n    thumbBar.append(wrapper);\n  }\n\n  attachBtn.onclick = () => fileInput.click();\n\n  fileInput.onchange = () => {\n\n    console.log(fileInput.files);\n\n    Array.from(fileInput.files || []).forEach(f => {\n      const blobUrl = URL.createObjectURL(f);\n      pendingAttachments.push({ file: f, blobUrl });\n      pushThumb(f, blobUrl);\n    });\n    fileInput.value = '';\n  };\n\n  /* ---------- view builders ---------- */\n  function buildNode(msg: ChatMessage, pending = false): HTMLElement {\n    const account = getAddress(msg.account);\n\n    const wrapper = el('div.message', {\n      className: `${pending ? 'pending' : ''} ${account === myAccount ? 'own' : ''}`.trim(),\n      dataset: { id: String(msg.id) }\n    });\n\n    const avatar = createJazzicon(account);\n    avatar.classList.add('avatar');\n\n    // 이름 표기\n    const cachedName = profileService.getCached(account)?.nickname || shortenAddress(account);\n    const meta = el(\n      'div.meta',\n      el('span.name', { dataset: { account } }, cachedName),\n      el('time.time', new Date(msg.timestamp).toLocaleTimeString())\n    );\n\n    const body = el('div.msg-body', meta);\n\n    if (msg.text) body.append(el('div.text', msg.text));\n\n    if (msg.attachments.length) {\n      const gallery = el('div.attachments',\n        ...msg.attachments.filter(a => a.kind === 'image')\n          .map(attachment => {\n            const a = el('a', { href: attachment.url, target: '_blank' });\n            const img = el(`img.img-msg`, { alt: 'image' }) as HTMLImageElement;\n            img.src = attachment.url;\n            if (!img.complete) {\n              img.classList.add('img-loading');\n              img.onload = () => img.classList.remove('img-loading');\n              img.onerror = () => replaceWithFallback(img);\n            }\n            a.append(img);\n            return a;\n          })\n      );\n      body.append(gallery);\n    }\n\n    wrapper.append(avatar, body);\n\n    // 프로필 요청\n    profileService.preload([account]);\n\n    return wrapper;\n  }\n\n  /* ---------- optimistic UI helpers ---------- */\n  function renderOptimistic(text: string, attachments: Attachment[], localId: string) {\n    const temp: ChatMessage = {\n      id: -1,\n      localId,\n      type: 'chat',\n      account: myAccount,\n      text,\n      attachments,\n      timestamp: Date.now()\n    };\n    const node = buildNode(temp, true);\n    node.dataset.localId = localId;\n    list.append(node);\n\n    waitForImages(node).then(() => {\n      scrollToBottom();\n    });\n\n    return node;\n  }\n\n  function overwritePlaceholder(placeholder: HTMLElement, real: ChatMessage) {\n    placeholder.replaceWith(buildNode(real));\n  }\n\n  function markFailed(node: HTMLElement) {\n    node.classList.remove('pending');\n    node.classList.add('failed');\n  }\n\n  function scrollToBottom() {\n    list.scrollTop = list.scrollHeight;\n  }\n\n  /* ---------- incoming messages ---------- */\n  service.addEventListener('message', (e) => {\n    const msg = (e as CustomEvent<ChatMessage>).detail;\n\n    if (msg.account === myAccount && msg.localId) {\n      const ph = list.querySelector<HTMLElement>(`.message.pending[data-local-id=\"${msg.localId}\"]`);\n      if (ph) { overwritePlaceholder(ph, msg); scrollToBottom(); return; }\n    }\n\n    if (list.querySelector(`[data-id=\"${msg.id}\"]`)) return;\n    list.append(buildNode(msg));\n\n    waitForImages(list).then(() => {\n      scrollToBottom();\n    });\n  });\n\n  /* ---------- outgoing messages ---------- */\n  async function sendCurrentInput() {\n    const text = (input.value as string).trim();\n    if (!text && pendingAttachments.length === 0) return;\n\n    input.value = '';\n\n    const tempAttachments: Attachment[] = pendingAttachments.map(p => ({\n      kind: 'image', url: p.blobUrl\n    }));\n    const localId = crypto.randomUUID();\n    const placeholder = renderOptimistic(text, tempAttachments, localId);\n\n    try {\n      const uploaded: Attachment[] = await Promise.all(\n        pendingAttachments.map(async (p) => {\n          const fd = new FormData(); fd.append('image', p.file);\n          const res = await fetch(`${API_URI}/upload-image`, {\n            method: 'POST',\n            body: fd,\n            headers: { Authorization: `Bearer ${TokenManager.getToken()}` }\n          });\n          const { imageUrl, thumbnailUrl } = await res.json();\n          return { kind: 'image', url: imageUrl, thumb: thumbnailUrl };\n        })\n      );\n\n      const saved = await service.send(text, uploaded, localId);\n\n      overwritePlaceholder(placeholder, saved);\n    } catch {\n      markFailed(placeholder);\n    } finally {\n      pendingAttachments.forEach(p => URL.revokeObjectURL(p.blobUrl));\n      pendingAttachments.length = 0;\n      thumbBar.innerHTML = '';\n    }\n  }\n\n  sendBtn.addEventListener('click', sendCurrentInput);\n\n  input.addEventListener(\n    'keydown',\n    (e: KeyboardEvent) => {\n      if (e.isComposing || e.key === 'Process') return;\n\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        sendCurrentInput();\n      }\n    },\n    { capture: true },\n  );\n\n  const onResize = () => {\n    scrollToBottom();\n  };\n\n  if (window.visualViewport) {\n    window.visualViewport.addEventListener('resize', onResize);\n  }\n\n  return {\n    el: root,\n    scrollToBottom,\n    remove() {\n      service.disconnect();\n      root.remove();\n\n      if (window.visualViewport) {\n        window.visualViewport.removeEventListener('resize', onResize);\n      }\n    }\n  };\n}\n\nexport { createChatComponent };\n"]}