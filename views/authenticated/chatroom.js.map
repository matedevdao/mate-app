{"version":3,"file":"chatroom.js","sourceRoot":"","sources":["../../../src/views/authenticated/chatroom.ts"],"names":[],"mappings":"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","sourcesContent":["import { el } from '@webtaku/el';\nimport Navigo from 'navigo';\nimport { View } from '../view';\nimport { tokenManager } from '@gaiaprotocol/client-common';\nimport { chatProfileService, createChatComponent } from '@gaiaprotocol/chat-client';\n\nimport { fetchHeldNfts, HeldNft } from '../../api/nfts';\nimport { fetchMyMainNft, setMainNft } from '../../api/main-nft';\nimport { createSelectMainNftModal } from '../../modals/select-main-nft';\n\nfunction getMyAccount(): string {\n  const token = tokenManager.getToken();\n  if (!token) return 'unknown';\n  try {\n    const payload = JSON.parse(atob(token.split('.')[1] || ''));\n    return payload.sub || 'unknown';\n  } catch {\n    return 'unknown';\n  }\n}\n\n// 상대 경로 이미지 보정 (환경에 맞게 수정)\nfunction toImageUrl(img?: string | null) {\n  if (!img) return '';\n  try {\n    return new URL(img).href; // 절대 경로면 그대로\n  } catch {\n    return `https://god-images.gaia.cc/${img}`; // 상대 경로면 프리픽스\n  }\n}\n\nfunction createChatRoomView(router: Navigo, roomId: string): View & {\n  scrollToBottom: () => void;\n} {\n  const page = el('div', { className: 'page flex flex-col h-screen p-4 gap-2' }, {\n    style: { height: '100%' }\n  });\n\n  /* ---------- ChatComponent ---------- */\n  const chat = createChatComponent({\n    roomId,\n    myAccount: getMyAccount(),\n  });\n\n  page.append(chat.el);\n\n  // ✅ 방(=컬렉션 주소) 기준으로 메인 NFT가 없으면 선택 모달 띄우기\n  (async () => {\n    const account = getMyAccount();\n    if (!account || account === 'unknown') return;\n\n    try {\n      const mine = await fetchMyMainNft(roomId);\n      const hasMain = !!mine?.token_id;\n\n      if (!hasMain) {\n        const modal = createSelectMainNftModal({\n          // 현재 방(컬렉션)의 내 보유 NFT 불러오기\n          loadItems: async () => {\n            const nfts: HeldNft[] = await fetchHeldNfts(account, { collection: roomId });\n            return nfts.map(n => ({\n              id: String(n.id ?? ''),         // 서버 응답 키에 맞춰 token_id 또는 id 사용\n              name: n.type ? `${n.type} #${n.id}` : `NFT #${n.id}`,\n              image: toImageUrl(n.image),\n              contractAddr: n.contract_addr,\n            }));\n          },\n          // 선택 시 저장\n          onSelected: async (contractAddr: string, tokenId: string) => {\n            await setMainNft({ collection: roomId, contractAddr, tokenId });\n            // 필요하면 여기서 채팅 UI/프로필 캐시 갱신 로직 추가\n            chatProfileService.preload([account]);\n          },\n          labels: {\n            title: '메인 NFT 선택',\n            description: '이 방에서 사용할 메인 NFT를 선택하세요.',\n          },\n        });\n\n        document.body.appendChild(modal);\n        (modal as any).present?.() || (modal as any).showModal?.();\n      }\n    } catch (e) {\n      console.error('메인 NFT 확인/표시 중 오류', e);\n      // 실패해도 채팅은 계속 동작하게 둠\n    }\n  })();\n\n  return {\n    el: page,\n    scrollToBottom: chat.scrollToBottom,\n    remove() {\n      chat.remove();\n      page.remove();\n    },\n  };\n}\n\nexport { createChatRoomView };\n"]}